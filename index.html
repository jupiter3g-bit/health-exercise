<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>健康体操アプリ</title>
  <style>
    body { text-align: center; font-family: sans-serif; background: #f0f0f0; }
    #mainImage { max-width: 80%; height: auto; margin-top: 20px; }
    button {
      margin: 10px auto;
      padding: 14px 28px;
      font-size: 20px;
      border-radius: 9999px;
      border: none;
      cursor: pointer;
      display: block;
    }
    #toggleBtn { width: 80%; background: #4CAF50; color: white; }
    #toggleBtn.stop { background: #f44336; color: white; }
    #goodbyeBtn { width: 50%; background: #555; color: white; display: none; }
    #sliderContainer { margin-top: 20px; }

    /* スライダー大きくして操作しやすく */
    #slider {
      width: 90%;
      height: 40px;
      margin-top: 10px;
    }
    #slider::-webkit-slider-thumb {
      width: 40px;
      height: 40px;
      background: #4CAF50;
      border-radius: 50%;
      cursor: pointer;
      margin-top: -5px;
    }
    #slider::-moz-range-thumb {
      width: 40px;
      height: 40px;
      background: #4CAF50;
      border-radius: 50%;
      cursor: pointer;
    }

    #timerDisplay, #intervalDisplay {
      margin-top: 10px;
      font-size: 18px;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>健康体操アプリ</h1>
  <img id="mainImage" src="img/standby.jpg" alt="待機画面">
  <div>
    <button id="toggleBtn" onclick="toggleShow()">スタート</button>
    <div id="timerDisplay">00:00</div>
    <div id="intervalDisplay">インターバル内: 0s / 2.0s</div>
  </div>
  <div id="sliderContainer">
    <label>テンポ: <span id="tempoValue">2.0</span> 秒</label><br>
    <input id="slider" type="range" min="500" max="5000" step="500" value="2000" oninput="updateTempo(this.value)">
  </div>

  <script>
    const images = ["img/img1.jpg","img/img2.jpg","img/img3.jpg","img/img4.jpg","img/img5.jpg","img/img6.jpg","img/img7.jpg","img/img8.jpg"];
    const sounds = ["snd/snd1.mp3","snd/snd2.mp3","snd/snd3.mp3","snd/snd4.mp3","snd/snd5.mp3","snd/snd6.mp3","snd/snd7.mp3","snd/snd8.mp3"];

    const audioElems = sounds.map(src => {
      let a = new Audio(src);
      a.preload = "auto";
      return a;
    });

    let timer = null;
    let interval = 2000;
    let elapsed = 0;
    let intervalElapsed = 0;
    let displayTimer = null;
    let firstPlayDone = false;

    // iPhone Safari 対策: 無音で再生権限を取得
    function unlockAudio() {
      audioElems.forEach(a => {
        a.muted = true;
        a.play().then(() => {
          a.pause();
          a.currentTime = 0;
          a.muted = false;
        }).catch(err => {});
      });
    }

    window.onload = function() {
      document.getElementById("intervalDisplay").textContent = `インターバル内: 0s / ${(interval/1000).toFixed(1)}s`;
    }

    function updateTempo(val) {
      interval = parseInt(val);
      document.getElementById("tempoValue").innerText = (interval / 1000).toFixed(1);
      document.getElementById("intervalDisplay").textContent = `インターバル内: 0s / ${(interval/1000).toFixed(1)}s`;
      if (timer) {
        stopShow();
        startShow();
      }
    }

    function toggleShow() {
      unlockAudio(); // 無音で再生権限取得

      const btn = document.getElementById("toggleBtn");
      const goodbyeBtn = document.getElementById("goodbyeBtn");

      if (timer) {
        stopShow();
        btn.textContent = "スタート";
        btn.classList.remove("stop");
        document.getElementById("sliderContainer").style.display = "block";
        goodbyeBtn.style.display = "none";
      } else {
        startShow();
        btn.textContent = "ストップ";
        btn.classList.add("stop");
        document.getElementById("sliderContainer").style.display = "none";
        goodbyeBtn.style.display = "block";
      }
    }

    function startShow() {
      if (timer) return;

      intervalElapsed = 0;
      updateIntervalDisplay();

      firstPlayDone = false; // 初回再生リセット
      showFirst(); // スタート直後の固定画像＋音声

      timer = setInterval(() => {
        showRandom();
        intervalElapsed = 0;
      }, interval);

      elapsed = 0;
      updateTimerDisplay();
      displayTimer = setInterval(() => {
        elapsed++;
        intervalElapsed++;
        updateTimerDisplay();
        updateIntervalDisplay();
      }, 1000);
    }

    function stopShow() {
      clearInterval(timer);
      timer = null;

      clearInterval(displayTimer);
      displayTimer = null;
      elapsed = 0;
      intervalElapsed = 0;
      updateTimerDisplay();
      updateIntervalDisplay();

      document.getElementById("mainImage").src = "img/standby.jpg";
    }

    function showFirst() {
      if (!firstPlayDone) {
        firstPlayDone = true;
        // 固定画像
        document.getElementById("mainImage").src = "img/fixed.jpg"; 
        // 固定音声
        let firstAudio = new Audio("snd/fixed.mp3");
        firstAudio.play().catch(err => console.log("First audio play error:", err));
      }
    }

    function updateTimerDisplay() {
      const min = String(Math.floor(elapsed / 60)).padStart(2, "0");
      const sec = String(elapsed % 60).padStart(2, "0");
      document.getElementById("timerDisplay").textContent = `${min}:${sec}`;
    }

    function updateIntervalDisplay() {
      document.getElementById("intervalDisplay").textContent =
        `インターバル内: ${intervalElapsed}s / ${(interval/1000).toFixed(1)}s`;
    }

    function showRandom() {
      let i = Math.floor(Math.random() * images.length);
      document.getElementById("mainImage").src = images[i];
      let audio = audioElems[i];
      audio.currentTime = 0;
      audio.play().catch(err => console.log("Audio play error:", err));
    }

    function goodbye() {
      stopShow();
      document.getElementById("mainImage").src = "img/standby.jpg";
      const btn = document.getElementById("toggleBtn");
      btn.textContent = "スタート";
      btn.classList.remove("stop");
      document.getElementById("sliderContainer").style.display = "block";
      document.getElementById("goodbyeBtn").style.display = "none";
    }
  </script>
</body>
</html>
